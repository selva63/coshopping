{% extends 'base.html' %}

{% block title %}Admin Dashboard - Admin Panel{% endblock %}

{% block content %}
<div class="flex justify-between items-center mb-8">
    <h1 class="text-4xl font-extrabold text-gray-800">Admin Dashboard</h1>
    <a href="{{ url_for('index') }}" class="text-blue-600 hover:underline font-semibold text-lg">‚Üê Back to Home</a>
</div>

<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
    <div class="bg-white rounded-xl shadow-lg p-6 text-center">
        <h2 class="text-xl font-bold text-gray-700 mb-2">Total Products</h2>
        <p class="text-5xl font-extrabold text-blue-600">{{ total_products }}</p>
    </div>
    <div class="bg-white rounded-xl shadow-lg p-6 text-center">
        <h2 class="text-xl font-bold text-gray-700 mb-2">Total Users</h2>
        <p class="text-5xl font-extrabold text-green-600">{{ total_users }}</p>
    </div>
    <div class="bg-white rounded-xl shadow-lg p-6 text-center">
        <h2 class="text-xl font-bold text-gray-700 mb-2">Total Orders</h2>
        <p class="text-5xl font-extrabold text-purple-600">{{ total_orders }}</p>
    </div>
    <div class="bg-white rounded-xl shadow-lg p-6 text-center">
        <h2 class="text-xl font-bold text-gray-700 mb-2">Pending Orders</h2>
        <p class="text-5xl font-extrabold text-yellow-600">{{ pending_orders }}</p>
    </div>
    <div class="bg-white rounded-xl shadow-lg p-6 text-center">
        <h2 class="text-xl font-bold text-gray-700 mb-2">Delivered Orders</h2>
        <p class="text-5xl font-extrabold text-teal-600">{{ delivered_orders_count }}</p>
    </div>
    <div class="bg-white rounded-xl shadow-lg p-6 text-center">
        <h2 class="text-xl font-bold text-gray-700 mb-2">Cancelled Orders</h2>
        <p class="text-5xl font-extrabold text-red-600">{{ cancelled_orders_count }}</p>
    </div>
    <div class="bg-white rounded-xl shadow-lg p-6 text-center">
        <h2 class="text-xl font-bold text-gray-700 mb-2">Leaved Orders</h2>
        <p class="text-5xl font-extrabold text-orange-600">{{ leaved_orders_count }}</p>
    </div>
</div>

<div class="bg-white rounded-xl shadow-lg p-8 mb-8">
    <h2 class="text-3xl font-bold text-gray-800 mb-6">Admin Actions</h2>
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
        <a href="{{ url_for('admin_products') }}" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-4 px-6 rounded-lg shadow-md transition duration-300 ease-in-out transform hover:scale-105 text-center flex items-center justify-center">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-3" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m7 0V5a2 2 0 012-2h2a2 2 0 012 2v6m-6 0h6" /></svg>
            Manage Products
        </a>
        <a href="{{ url_for('admin_users') }}" class="bg-green-500 hover:bg-green-600 text-white font-bold py-4 px-6 rounded-lg shadow-md transition duration-300 ease-in-out transform hover:scale-105 text-center flex items-center justify-center">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-3" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M17 20h2a2 2 0 002-2V4a2 2 0 00-2-2H5a2 2 0 00-2 2v14a2 2 0 002 2h2m0 0a2 2 0 100 4 2 2 0 000-4zm0 0H9m4 0h6M7 13V7a2 2 0 012-2h6a2 2 0 012 2v6m-3 0V7" /></svg>
            Manage Users
        </a>
        <a href="{{ url_for('admin_orders') }}" class="bg-purple-500 hover:bg-purple-600 text-white font-bold py-4 px-6 rounded-lg shadow-md transition duration-300 ease-in-out transform hover:scale-105 text-center flex items-center justify-center">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-3" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" /></svg>
            Manage Orders
        </a>
        <a href="{{ url_for('admin_pincodes') }}" class="bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-4 px-6 rounded-lg shadow-md transition duration-300 ease-in-out transform hover:scale-105 text-center flex items-center justify-center">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-3" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" /><path stroke-linecap="round" stroke-linejoin="round" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" /></svg>
            Verify Pincodes
        </a>
        <a href="{{ url_for('admin_delivery_boys') }}" class="bg-orange-500 hover:bg-orange-600 text-white font-bold py-4 px-6 rounded-lg shadow-md transition duration-300 ease-in-out transform hover:scale-105 text-center flex items-center justify-center">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-3" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path d="M9 17a2 2 0 11-4 0 2 2 0 014 0zM19 17a2 2 0 11-4 0 2 2 0 014 0z" /><path stroke-linecap="round" stroke-linejoin="round" d="M13 16V6a1 1 0 00-1-1H4a1 1 0 00-1 1v10l2-2h8a1 1 0 001-1z" /></svg>
            Manage Delivery Boys
        </a>
    </div>
</div>

{% macro render_order_list(orders, table_title, show_reason=False, reason_title="Reason") %}
<div class="bg-white rounded-xl shadow-lg p-4 md:p-8 mt-8">
    <h2 class="text-3xl font-bold text-gray-800 mb-6 px-2 md:px-0">{{ table_title }}</h2>
    {% if orders %}
        <div class="hidden md:grid md:grid-cols-10 gap-6 font-bold text-left text-xs text-gray-500 uppercase tracking-wider px-6 py-3 border-b">
            <div class="col-span-1">Order ID</div>
            <div class="col-span-2">Products</div>
            <div class="col-span-1">Customer</div>
            <div class="col-span-1">Order Date</div>
            <div class="col-span-2">Address</div>
            <div class="col-span-2">{% if show_reason %}{{ reason_title }}{% else %}Status{% endif %}</div>
            <div class="col-span-1">Delivery Boy</div>
        </div>

        <div class="grid grid-cols-1 gap-4 md:space-y-0">
            {% for order in orders %}
            <div class="md:hidden bg-gray-50 rounded-lg p-4 border border-gray-200 space-y-3">
                <div class="flex justify-between items-center pb-2 border-b">
                    <p class="text-sm font-medium text-gray-500">Order ID</p>
                    <p class="text-sm font-semibold text-gray-800">#{{ order.id }}</p>
                </div>
                <div class="flex justify-between items-start py-2 border-b">
                    <p class="text-sm font-medium text-gray-500">Customer</p>
                    <div class="text-right">
                        <p class="text-sm font-semibold text-gray-800">{{ order.customer_name }}</p>
                        {% if order.shipping_name %}<p class="text-xs text-gray-500">({{ order.shipping_name }})</p>{% endif %}
                    </div>
                </div>
                <div class="py-2 border-b">
                    <p class="text-sm font-medium text-gray-500 mb-1">Products</p>
                    {% if order.order_items %}
                        <ul class="list-disc list-inside text-sm text-gray-700 pl-2">
                        {% for item in order.order_items %}
                            <li>{{ item.name }} (Qty: {{ item.quantity }})</li>
                        {% endfor %}
                        </ul>
                    {% else %} N/A {% endif %}
                </div>
                <div class="py-2 border-b">
                    <p class="text-sm font-medium text-gray-500 mb-1">Address</p>
                     <div class="text-sm text-gray-800">
                        <p>{{ order.address_line1 }}</p>
                        {% if order.address_line2 %}<p>{{ order.address_line2 }}</p>{% endif %}
                        <p>{{ order.city }}, {{ order.state }} - {{ order.zip_code }}</p>
                    </div>
                </div>
                    <div class="flex justify-between items-center py-2 border-b">
                    <p class="text-sm font-medium text-gray-500">Delivery Boy</p>
                    <p class="text-sm font-semibold text-gray-800">{{ order.delivery_boy_name if order.delivery_boy_name else 'Not Assigned' }}</p>
                </div>
                <div class="flex justify-between items-center py-2 border-b">
                    <p class="text-sm font-medium text-gray-500">Order Date</p>
                    <p class="text-sm text-gray-800">{{ order.order_date }}</p>
                </div>
                <div class="flex justify-between items-center pt-3">
                    <div>
                        <p class="text-sm font-medium text-gray-500 mb-1">{{ reason_title if show_reason else "Status" }}</p>
                             {% if show_reason %}
                                 {% set parts = order.cancellation_reason.split('::') %}
                                 {% if parts|length > 3 %}
                                     <p class="text-sm"><strong>By:</strong> {{ parts[1] }} (Delivery Boy)</p>
                                     <button type="button" class="text-blue-600 text-sm font-semibold hover:underline view-reason-btn mt-1" data-reason="{{ parts[3] }}">View Reason</button>
                                 {% else %}
                                     <button type="button" class="text-blue-600 text-sm font-semibold hover:underline view-reason-btn" data-reason="{{ order.cancellation_reason }}">View Reason</button>
                                 {% endif %}
                             {% else %}
                                 <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full
                                     {% if order.status == 'Pending' %} bg-yellow-100 text-yellow-800
                                     {% elif order.status in ['Out for Delivery', 'Product Left from Shop', '10 Minutes Left for Delivery', 'Order Picked Up'] %} bg-orange-100 text-orange-800
                                     {% elif order.status == 'Delivered' %} bg-green-100 text-green-800
                                     {% elif order.status == 'Cancelled' %} bg-red-100 text-red-800
                                     {% else %} bg-blue-100 text-blue-800
                                     {% endif %}">
                                     {{ order.status }}
                                 </span>
                             {% endif %}
                    </div>
                    <a href="{{ url_for('order_detail', order_id=order.id) }}" class="bg-blue-600 text-white py-2 px-4 rounded-lg font-semibold text-sm hover:bg-blue-700 transition">View Details</a>
                </div>
            </div>

            <div class="hidden md:grid md:grid-cols-10 gap-6 items-start border-b last:border-b-0 hover:bg-gray-50 transition duration-200 px-6 py-4">
                <div class="col-span-1 text-sm font-medium text-gray-900">#{{ order.id }}</div>
                <div class="col-span-2 text-sm text-gray-700">
                    {% if order.order_items %}
                        <ul class="list-disc list-inside">
                        {% for item in order.order_items %}
                            <li class="truncate">{{ item.name }} (Qty: {{ item.quantity }})</li>
                        {% endfor %}
                        </ul>
                    {% else %} N/A {% endif %}
                </div>
                <div class="col-span-1 text-sm text-gray-900">
                    {{ order.customer_name }}
                    {% if order.shipping_name %}<span class="block text-xs text-gray-500">({{ order.shipping_name }})</span>{% endif %}
                </div>
                <div class="col-span-1 text-sm text-gray-500">{{ order.order_date }}</div>
                <div class="col-span-2 text-sm text-gray-500">
                    <p>{{ order.address_line1 }}</p>
                    {% if order.address_line2 %}<p>{{ order.address_line2 }}</p>{% endif %}
                    <p>{{ order.city }}, {{ order.state }} - {{ order.zip_code }}</p>
                </div>
                <div class="col-span-2 text-left text-sm">
                    {% if show_reason %}
                        {% if order.cancellation_reason %}
                            {% set parts = order.cancellation_reason.split('::') %}
                            {% if parts|length > 3 %}
                                <p><strong>By:</strong> {{ parts[1] }} (Delivery Boy)</p>
                                <button type="button" class="text-blue-600 hover:underline view-reason-btn mt-1 text-sm font-bold" data-reason="{{ parts[3] }}">View Reason</button>
                            {% else %}
                                <button type="button" class="text-blue-600 hover:underline view-reason-btn text-sm font-bold" data-reason="{{ order.cancellation_reason }}">View Reason</button>
                            {% endif %}
                        {% else %} N/A {% endif %}
                    {% else %}
                        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full
                            {% if order.status == 'Pending' %} bg-yellow-100 text-yellow-800
                            {% elif order.status in ['Out for Delivery', 'Product Left from Shop', '10 Minutes Left for Delivery', 'Order Picked Up'] %} bg-orange-100 text-orange-800
                            {% elif order.status == 'Delivered' %} bg-green-100 text-green-800
                            {% elif order.status == 'Cancelled' %} bg-red-100 text-red-800
                            {% else %} bg-blue-100 text-blue-800
                            {% endif %}">
                            {{ order.status }}
                        </span>
                    {% endif %}
                </div>
                <div class="col-span-1 text-left">
                    <div class="flex flex-col items-start justify-start h-full">
                        <p class="text-sm text-gray-500">{{ order.delivery_boy_name if order.delivery_boy_name else 'Not Assigned' }}</p>
                        <a href="{{ url_for('order_detail', order_id=order.id) }}" class="text-blue-600 hover:text-blue-900 transition duration-300 font-semibold text-sm mt-2">View Details</a>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    {% else %}
        <div class="text-center py-8">
            <p class="text-xl text-gray-600">No orders found in this category.</p>
        </div>
    {% endif %}
</div>
{% endmacro %}

{{ render_order_list(ongoing_orders, 'Ongoing Orders') }}
{{ render_order_list(delivered_orders, 'Delivered Orders') }}
{{ render_order_list(cancelled_orders, 'Cancelled Orders', show_reason=True, reason_title="Reason for Cancellation") }}
{{ render_order_list(leaved_orders, 'Leaved Orders', show_reason=True, reason_title="Reason for Leaving") }}


<div id="reasonModal" class="fixed z-50 inset-0 overflow-y-auto hidden" aria-labelledby="modal-title" role="dialog" aria-modal="true">
    <div class="flex items-end justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
        <div id="modal-overlay" class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity" aria-hidden="true"></div>
        <span class="hidden sm:inline-block sm:align-middle sm:h-screen" aria-hidden="true">&#8203;</span>
        <div class="inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full">
            <div class="bg-white px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                <h3 class="text-lg leading-6 font-medium text-gray-900" id="modal-title">Reason</h3>
                <div class="mt-2">
                    <p class="text-sm text-gray-600 whitespace-pre-wrap break-words" id="reason-text-content"></p>
                </div>
            </div>
            <div class="bg-gray-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
                <button type="button" id="close-modal-btn" class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 sm:mt-0 sm:w-auto sm:text-sm">
                    Close
                </button>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const reasonModal = document.getElementById('reasonModal');
    const modalOverlay = document.getElementById('modal-overlay');
    const reasonTextContent = document.getElementById('reason-text-content');
    const closeModalBtn = document.getElementById('close-modal-btn');
    const viewReasonBtns = document.querySelectorAll('.view-reason-btn');

    function openModal(reason) {
        reasonTextContent.textContent = reason;
        reasonModal.classList.remove('hidden');
    }

    function closeModal() {
        reasonModal.classList.add('hidden');
    }

    viewReasonBtns.forEach(button => {
        button.addEventListener('click', function() {
            const reason = this.getAttribute('data-reason');
            openModal(reason);
        });
    });

    closeModalBtn.addEventListener('click', closeModal);
    modalOverlay.addEventListener('click', closeModal);
});
</script>

{% endblock %}

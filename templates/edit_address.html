{# templates/edit_address.html #}
{% extends 'base.html' %}

{% block title %}Edit Address - CO Shopping{% endblock %}

{% block content %}
<div class="flex items-center justify-center min-h-[calc(100vh-150px)]">
    <div class="bg-white rounded-xl shadow-lg p-8 md:p-10 w-full max-w-xl">
        <h1 class="text-3xl font-extrabold text-gray-800 mb-6 text-center">Edit Shipping Address</h1>

        <form method="POST" action="{{ url_for('edit_address', address_id=address.id) }}"
              data-current-city="{{ address.city }}" {# Pass current city via data attribute #}
              data-current-pincode="{{ address.zip_code }}"> {# Pass current pincode via data attribute #}

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div class="mb-4">
                    <label for="full_name" class="block text-gray-700 text-sm font-bold mb-2">Full Name:</label>
                    <input type="text" id="full_name" name="full_name" required
                           class="shadow appearance-none border rounded-lg w-full py-3 px-4 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition duration-200"
                           value="{{ address.full_name }}">
                </div>

                <div class="mb-4">
                    <label for="phone_number" class="block text-gray-700 text-sm font-bold mb-2">Phone Number:</label>
                    <input type="tel" id="phone_number" name="phone_number" required
                           class="shadow appearance-none border rounded-lg w-full py-3 px-4 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition duration-200"
                           pattern="[0-9]{10}" title="Please enter a 10-digit mobile number." placeholder="10-digit number"
                           value="{{ address.phone_number }}">
                </div>

                <div class="mb-4 md:col-span-2">
                    <label for="address_line1" class="block text-gray-700 text-sm font-bold mb-2">Address Line 1 (Door No, Street):</label>
                    <input type="text" id="address_line1" name="address_line1" required
                           class="shadow appearance-none border rounded-lg w-full py-3 px-4 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition duration-200"
                           value="{{ address.address_line1 }}">
                </div>
                <div class="mb-4 md:col-span-2">
                    <label for="address_line2" class="block text-gray-700 text-sm font-bold mb-2">Address Line 2 (Landmark, Optional):</label>
                    <input type="text" id="address_line2" name="address_line2"
                           class="shadow appearance-none border rounded-lg w-full py-3 px-4 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition duration-200"
                           value="{{ address.address_line2 if address.address_line2 else '' }}">
                </div>

                <div class="mb-4">
                    <label for="zip_code" class="block text-gray-700 text-sm font-bold mb-2">Zip/Postal Code:</label>
                    <input type="text" id="zip_code" name="zip_code" required
                           class="shadow appearance-none border rounded-lg w-full py-3 px-4 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition duration-200"
                           maxlength="6" pattern="\d{6}" title="Please enter a 6-digit pincode."
                           value="{{ address.zip_code }}">
                    <div id="pincode-error" class="text-red-500 text-xs mt-1"></div>
                </div>

                <div class="mb-4">
                    <label for="city" class="block text-gray-700 text-sm font-bold mb-2">City / Area:</label>
                    <select id="city" name="city" required
                            class="shadow appearance-none border rounded-lg w-full py-3 px-4 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition duration-200">
                        {# Default option will be populated by JS, or keep a placeholder #}
                        <option value="">Select City/Area</option>
                    </select>
                </div>

                <div class="mb-4">
                    <label for="state" class="block text-gray-700 text-sm font-bold mb-2">State/Province:</label>
                    <input type="text" id="state" name="state" required readonly
                           class="shadow appearance-none border rounded-lg w-full py-3 px-4 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition duration-200 bg-gray-200"
                           value="{{ address.state }}">
                </div>

                <div class="mb-4">
                    <label for="country" class="block text-gray-700 text-sm font-bold mb-2">Country:</label>
                    <input type="text" id="country" name="country" required readonly
                           class="shadow appearance-none border rounded-lg w-full py-3 px-4 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition duration-200 bg-gray-200"
                           value="{{ address.country }}">
                </div>
            </div>
            <div class="mb-6 flex items-center">
                <input type="checkbox" id="is_default" name="is_default" class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded" {% if address.is_default %}checked{% endif %}>
                <label for="is_default" class="ml-2 block text-gray-900 text-sm">Set as default address</label>
            </div>
            <div class="flex items-center justify-between">
                <button type="submit"
                        class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-full shadow-lg transition duration-300 ease-in-out transform hover:scale-105 focus:outline-none focus:ring-4 focus:ring-blue-300 w-full">
                    Update Address
                </button>
            </div>
        </form>
        <p class="text-center text-gray-600 text-sm mt-6">
            <a href="{{ url_for('view_addresses') }}" class="text-blue-600 hover:underline font-semibold">‚Üê Back to Addresses</a>
        </p>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const zipCodeInput = document.getElementById('zip_code');
    const citySelect = document.getElementById('city');
    const stateInput = document.getElementById('state');
    const countryInput = document.getElementById('country');
    const pincodeError = document.getElementById('pincode-error');
    const form = document.querySelector('form'); // Get the form element

    // Retrieve values from data attributes on the form
    const currentCityFromData = form.dataset.currentCity;
    const currentPincodeFromData = form.dataset.currentPincode;

    // Function to fetch and populate city/area options
    function fetchAndPopulatePincodeData(pincode, preSelectCity = null) {
        pincodeError.textContent = ''; // Clear previous errors

        if (pincode.length !== 6) {
            citySelect.innerHTML = '<option value="">Enter Zip Code First</option>';
            citySelect.disabled = true;
            citySelect.classList.add('bg-gray-200');
            stateInput.value = '';
            countryInput.value = '';
            return;
        }

        citySelect.innerHTML = '<option value="">Loading...</option>';
        citySelect.disabled = true;
        citySelect.classList.add('bg-gray-200');

        fetch(`https://api.postalpincode.in/pincode/${pincode}`)
            .then(response => response.json())
            .then(data => {
                if (data && data[0].Status === 'Success') {
                    const postOffices = data[0].PostOffice;

                    citySelect.innerHTML = '';
                    citySelect.innerHTML = '<option value="">-- Select your Area --</option>';

                    postOffices.forEach(office => {
                        let officeName = office.Name;
                        if (officeName === 'Vyrichettipalayam') {
                            officeName = 'Vairichettipalayam';
                        }
                        const option = document.createElement('option');
                        option.value = officeName;
                        option.textContent = officeName;
                        // Pre-select the option if it matches the current address city or a specified city
                        if (officeName === preSelectCity) {
                            option.selected = true;
                        }
                        citySelect.appendChild(option);
                    });

                    if (postOffices.length > 0) {
                        stateInput.value = postOffices[0].State;
                        countryInput.value = postOffices[0].Country;
                    }

                    citySelect.disabled = false;
                    citySelect.classList.remove('bg-gray-200');

                } else {
                    pincodeError.textContent = 'Invalid Pincode. Please check.';
                    citySelect.innerHTML = '<option value="">Invalid Zip Code</option>';
                    stateInput.value = '';
                    countryInput.value = '';
                }
            })
            .catch(error => {
                console.error('Error fetching pincode data:', error);
                pincodeError.textContent = 'Could not fetch details. Check connection.';
                citySelect.innerHTML = '<option value="">Error fetching data</option>';
            });
    }

    // Initial call on page load to pre-populate for the existing address
    // Use data attributes for initial population to avoid Jinja in JS
    if (currentPincodeFromData) {
        fetchAndPopulatePincodeData(currentPincodeFromData, currentCityFromData);
    }

    zipCodeInput.addEventListener('input', function() {
        fetchAndPopulatePincodeData(zipCodeInput.value); // No pre-selection needed on new input
    });
});
</script>
{% endblock %}
{% extends 'base.html' %}

{% block title %}Delivery Boy Dashboard - CO Shopping{% endblock %}

{% block content %}
<div class="flex justify-between items-center mb-8">
    <h1 class="text-4xl font-extrabold text-gray-800">Delivery Boy Dashboard</h1>
    <a href="{{ url_for('logout') }}" class="text-red-600 hover:underline font-semibold text-lg">Logout</a>
</div>

<div class="bg-white rounded-xl shadow-lg p-6 md:p-8 mb-8">
    <h2 class="text-3xl font-bold text-gray-800 mb-6">Welcome, {{ current_user.username }}!</h2>
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
        <div class="bg-gray-50 rounded-lg p-6 shadow-sm">
            <h3 class="text-xl font-semibold text-gray-700 mb-3">Your Profile</h3>
            <p class="text-gray-600 mb-2"><span class="font-medium">Name:</span> {{ delivery_boy_info.name }}</p>
            <p class="text-gray-600 mb-2"><span class="font-medium">Mobile:</span> {{ delivery_boy_info.mobile_number }}</p>
            <p class="text-gray-600 mb-2"><span class="font-medium">WhatsApp:</span> {{ delivery_boy_info.whatsapp_mobile_number }}</p>
            <p class="text-gray-600"><span class="font-medium">Your Pincodes:</span>
                <span class="font-semibold">{{ pincode_list | join(', ') if pincode_list else 'N/A' }}</span>
            </p>
        </div>
        <div class="bg-gray-50 rounded-lg p-6 shadow-sm">
            <h3 class="text-xl font-semibold text-gray-700 mb-3">Quick Summary</h3>
            <p class="text-gray-600 mb-2"><span class="font-medium">Active Orders:</span> <span class="font-bold text-blue-600">{{ active_orders | length }}</span></p>
            <p class="text-gray-600 mb-2"><span class="font-medium">Delivered Orders:</span> <span class="font-bold text-green-600">{{ delivered_orders | length }}</span></p>
            <p class="text-gray-600 mb-2"><span class="font-medium">Cancelled Orders:</span> <span class="font-bold text-red-600">{{ cancelled_orders | length }}</span></p>
            <p class="text-gray-600 mb-2"><span class="font-medium">Leaved Orders:</span> <span class="font-bold text-orange-600">{{ leaved_orders_count }}</span></p>
        </div>
    </div>
</div>

{% macro render_order_list(orders, table_title, show_reason=False, reason_title="Reason") %}
<div class="bg-white rounded-xl shadow-lg p-4 md:p-8 mb-8">
    <h2 class="text-2xl font-bold text-gray-800 mb-4 px-2 md:px-0">{{ table_title }}</h2>
    {% if orders %}
        <div class="hidden md:grid md:grid-cols-8 gap-6 font-bold text-left text-xs text-gray-500 uppercase tracking-wider px-6 py-3 border-b">
            <div class="col-span-1">Order ID</div>
            <div class="col-span-2">Products</div>
            <div class="col-span-1">Customer</div>
            <div class="col-span-1">Order Date</div>
            <div class="col-span-2">Address</div>
            <div class="col-span-1">{% if show_reason %}{{ reason_title }}{% else %}Status{% endif %}</div>
        </div>
        <div class="grid grid-cols-1 gap-4 md:space-y-0">
            {% for order in orders %}
            <div class="md:hidden bg-gray-50 rounded-lg p-4 border border-gray-200 space-y-3">
                <div class="flex justify-between items-center pb-2 border-b">
                    <p class="text-sm font-medium text-gray-500">Order ID</p>
                    <p class="text-sm font-semibold text-gray-800">#{{ order.id }}</p>
                </div>
                <div class="flex justify-between items-start py-2 border-b">
                    <p class="text-sm font-medium text-gray-500">Customer</p>
                    <div class="text-right">
                        <p class="text-sm font-semibold text-gray-800">{{ order.username }}</p>
                        {% if order.full_name %}<p class="text-xs text-gray-500">({{ order.full_name }})</p>{% endif %}
                    </div>
                </div>
                <div class="py-2 border-b">
                    <p class="text-sm font-medium text-gray-500 mb-1">Products</p>
                    {% if order.order_items %}
                        <ul class="list-disc list-inside text-sm text-gray-700 pl-2">
                        {% for item in order.order_items %}
                            <li>{{ item.name }} (Qty: {{ item.quantity }})</li>
                        {% endfor %}
                        </ul>
                    {% else %} N/A {% endif %}
                </div>
                <div class="py-2 border-b">
                    <p class="text-sm font-medium text-gray-500 mb-1">Address</p>
                     <div class="text-sm text-gray-800">
                        <p>{{ order.address_line1 }}</p>
                        {% if order.address_line2 %}<p>{{ order.address_line2 }}</p>{% endif %}
                        <p>{{ order.city }}, {{ order.state }} - {{ order.zip_code }}</p>
                    </div>
                </div>
                <div class="flex justify-between items-center py-2 border-b">
                    <p class="text-sm font-medium text-gray-500">Order Date</p>
                    <p class="text-sm text-gray-800">{{ order.order_date }}</p>
                </div>
                <div class="flex justify-between items-center pt-3">
                    <div>
                        <p class="text-sm font-medium text-gray-500 mb-1">{{ reason_title if show_reason else "Status" }}</p>
                             {% if show_reason %}
                                 {% set reason_text = order.cancellation_reason %}
                                 {% if reason_text and reason_text.startswith(('Cancelled by Delivery Boy::', 'Left by Delivery Boy::')) %}
                                     {% set parts = reason_text.split('::') %}
                                     {% if parts|length > 3 %}
                                         <p class="text-sm"><strong>By:</strong> {{ parts[1] }} (Delivery Boy)</p>
                                         <button type="button" class="text-blue-600 hover:underline view-reason-btn text-sm font-semibold" data-reason="{{ parts[3] }}">
                                             View Reason
                                         </button>
                                     {% else %}
                                         <button type="button" class="text-blue-600 text-sm font-semibold hover:underline view-reason-btn" data-reason="{{ order.cancellation_reason }}">View Reason</button>
                                     {% endif %}
                                 {% elif reason_text and reason_text.startswith('Cancelled by customer: ') %}
                                     {% set display_reason = reason_text[21:] %}
                                     <button type="button" class="text-blue-600 text-sm font-semibold hover:underline view-reason-btn" data-reason="{{ display_reason }}">View Reason</button>
                                 {% else %}
                                     {% set display_reason = reason_text %}
                                     <button type="button" class="text-blue-600 text-sm font-semibold hover:underline view-reason-btn" data-reason="{{ display_reason or 'No reason provided.' }}">View Reason</button>
                                 {% endif %}
                             {% else %}
                                 <span class="px-3 py-1 inline-flex text-xs leading-5 font-semibold rounded-full
                                     {% if order.status == 'Pending' %} bg-yellow-100 text-yellow-800
                                     {% elif order.status == 'Delivered' %} bg-green-100 text-green-800
                                     {% elif order.status == 'Cancelled' %} bg-red-100 text-red-800
                                     {% else %} bg-orange-100 text-orange-800
                                     {% endif %}">
                                     {{ order.status }}
                                 </span>
                             {% endif %}
                    </div>
                    <a href="{{ url_for('order_detail', order_id=order.id) }}" class="bg-blue-600 text-white py-2 px-4 rounded-lg font-semibold text-sm hover:bg-blue-700 transition">View Details</a>
                </div>
            </div>

            <div class="hidden md:grid md:grid-cols-8 gap-6 items-center border-b last:border-b-0 hover:bg-gray-50 transition duration-200 px-6 py-4">
                <div class="col-span-1 text-sm font-medium text-gray-900">#{{ order.id }}</div>
                <div class="col-span-2 text-sm text-gray-700">
                    {% if order.order_items %}
                        <ul class="list-disc list-inside">
                        {% for item in order.order_items %}
                            <li class="truncate">{{ item.name }} (Qty: {{ item.quantity }})</li>
                        {% endfor %}
                        </ul>
                    {% else %} N/A {% endif %}
                </div>
                <div class="col-span-1 text-sm text-gray-900">
                    {{ order.customer_name }}
                    {% if order.shipping_name %}<span class="block text-xs text-gray-500">({{ order.shipping_name }})</span>{% endif %}
                </div>
                <div class="col-span-1 text-sm text-gray-500">{{ order.order_date }}</div>
                <div class="col-span-2 text-sm text-gray-500">
                    <p>{{ order.address_line1 }}</p>
                    {% if order.address_line2 %}<p>{{ order.address_line2 }}</p>{% endif %}
                    <p>{{ order.city }}, {{ order.state }} - {{ order.zip_code }}</p>
                </div>
                <div class="col-span-1 text-left">
                    <div class="flex flex-col h-full justify-center {% if show_reason %}items-center{% else %}items-start{% endif %}">
                        {% if show_reason %}
                            {% set reason_text = order.cancellation_reason %}
                            {% if reason_text and reason_text.startswith(('Cancelled by Delivery Boy::', 'Left by Delivery Boy::')) %}
                                {% set parts = reason_text.split('::') %}
                                {% if parts|length > 3 %}
                                    <p class="text-sm"><strong>By:</strong> {{ parts[1] }} (Delivery Boy)</p>
                                    <button type="button" class="text-blue-600 hover:underline view-reason-btn mt-1 text-sm font-bold" data-reason="{{ parts[3] }}">View Reason</button>
                                {% else %}
                                    <button type="button" class="text-blue-600 hover:underline view-reason-btn text-sm font-bold" data-reason="{{ order.cancellation_reason }}">View Reason</button>
                                {% endif %}
                            {% elif reason_text and reason_text.startswith('Cancelled by customer: ') %}
                                {% set display_reason = reason_text[21:] %}
                                <button type="button" class="text-blue-600 hover:underline view-reason-btn text-sm font-bold" data-reason="{{ display_reason }}">View Reason</button>
                            {% else %}
                                {% set display_reason = reason_text %}
                                <button type="button" class="text-blue-600 hover:underline view-reason-btn text-sm font-bold" data-reason="{{ display_reason or 'No reason provided.' }}">View Reason</button>
                            {% endif %}
                        {% else %}
                            <span class="px-3 py-1 inline-flex text-xs leading-5 font-semibold rounded-full
                                {% if order.status == 'Pending' %} bg-yellow-100 text-yellow-800
                                {% elif order.status == 'Delivered' %} bg-green-100 text-green-800
                                {% elif order.status == 'Cancelled' %} bg-red-100 text-red-800
                                {% else %} bg-orange-100 text-orange-800
                                {% endif %}">
                                {{ order.status }}
                            </span>
                        {% endif %}
                        <a href="{{ url_for('order_detail', order_id=order.id) }}" class="text-blue-600 hover:text-blue-900 transition duration-300 font-semibold text-sm mt-2">View Details</a>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    {% else %}
        <div class="text-center py-8">
            <p class="text-xl text-gray-600 mb-4">No orders found in this category.</p>
        </div>
    {% endif %}
</div>
{% endmacro %}


{{ render_order_list(active_orders, 'Pending Orders') }}
{{ render_order_list(delivered_orders, 'Delivered Orders') }}
{{ render_order_list(cancelled_orders, 'My Cancelled Orders', show_reason=True, reason_title="Reason") }}
{{ render_order_list(leaved_orders, 'My Leaved Orders', show_reason=True, reason_title="Reason") }}


<div id="reasonModal" class="fixed z-50 inset-0 overflow-y-auto hidden" aria-labelledby="modal-title" role="dialog" aria-modal="true">
    <div class="flex items-end justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
        <div id="modal-overlay" class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity" aria-hidden="true"></div>
        <span class="hidden sm:inline-block sm:align-middle sm:h-screen" aria-hidden="true">&#8203;</span>
        <div class="inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full">
            <div class="bg-white px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                <h3 class="text-lg leading-6 font-medium text-gray-900" id="modal-title">Reason</h3>
                <div class="mt-2">
                    <p class="text-sm text-gray-600 whitespace-pre-wrap break-words" id="reason-text-content"></p>
                </div>
            </div>
            <div class="bg-gray-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
                <button type="button" id="close-modal-btn" class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 sm:mt-0 sm:w-auto sm:text-sm">
                    Close
                </button>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const reasonModal = document.getElementById('reasonModal');
    const modalOverlay = document.getElementById('modal-overlay');
    const reasonTextContent = document.getElementById('reason-text-content');
    const closeModalBtn = document.getElementById('close-modal-btn');
    const viewReasonBtns = document.querySelectorAll('.view-reason-btn');

    function openModal(reason) {
        reasonTextContent.textContent = reason;
        reasonModal.classList.remove('hidden');
    }

    function closeModal() {
        reasonModal.classList.add('hidden');
    }

    viewReasonBtns.forEach(button => {
        button.addEventListener('click', function() {
            const reason = this.getAttribute('data-reason');
            openModal(reason);
        });
    });

    closeModalBtn.addEventListener('click', closeModal);
    modalOverlay.addEventListener('click', closeModal);
});
</script>

{% endblock %}

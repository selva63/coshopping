{% extends 'base.html' %}

{% block title %}All Products - CO Shopping{% endblock %}

{% block content %}
{# Conditional heading for admin vs. regular user #}
{% if current_user.is_authenticated and is_admin %}
    <h1 class="text-4xl font-extrabold text-gray-800 mb-8 text-center">Your Products</h1>
{% else %}
    <h1 class="text-4xl font-extrabold text-gray-800 mb-8 text-center">Our Amazing Products</h1>
{% endif %}


<div class="flex flex-col md:flex-row justify-between items-center mb-8 space-y-4 md:space-y-0 md:space-x-4">
    {# Search query display #}
    {% if search_query %}
        <p class="text-xl text-gray-700 font-semibold">Showing results for: "<span class="text-blue-600">{{ search_query }}</span>"</p>
    {% else %}
        {# Conditional text for admin vs. regular user #}
        {% if current_user.is_authenticated and is_admin %}
            <p class="text-xl text-gray-700 font-semibold">Browse your collection</p>
        {% else %}
            <p class="text-xl text-gray-700 font-semibold">Browse our collection</p>
        {% endif %}
    {% endif %}

    {# Category Filter #}
    <form action="{{ url_for('index') }}" method="GET" class="w-full md:w-auto flex items-center space-x-2">
        <label for="category-select" class="text-gray-700 font-medium">Filter by Category:</label>
        <select id="category-select" name="category" onchange="this.form.submit()"
                class="block w-full md:w-auto px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition duration-200 bg-white">
            {% for cat in categories %}
                <option value="{{ cat }}" {% if selected_category == cat %}selected{% endif %}>{{ cat }}</option>
            {% endfor %}
        </select>
        {# Keep the search query hidden if present, so filter applies to search results #}
        {% if search_query %}
            <input type="hidden" name="q" value="{{ search_query }}">
        {% endif %}
    </form>
</div>

{% if products %}
    <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4 md:gap-8">
        {% for product in products %}
        <div class="bg-white rounded-xl shadow-lg hover:shadow-xl transition-shadow duration-300 overflow-hidden flex flex-col">
            {# The image container needs to be relative for absolute positioning of icons #}
            <div class="relative">
                <a href="{{ url_for('product_detail', product_id=product.id) }}" class="block">
                    <img src="{{ product.image_url }}" alt="{{ product.name }}" class="w-full h-48 object-cover rounded-t-xl"
                            onerror="this.onerror=null;this.src='https://placehold.co/400x300/CCCCCC/000000?text=Image+Not+Found';">
                </a>

                {# Admin Icons on Image - Only for admins #}
                {% if current_user.is_authenticated and is_admin %}
                    <div class="absolute top-2 right-2 flex space-x-2 z-10">
                        <a href="{{ url_for('admin_edit_product', product_id=product.id) }}"
                           class="bg-transparent text-white transition duration-300 ease-in-out transform hover:scale-110 hover:text-gray-700"
                           title="Edit Product">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                <path d="M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793zM11.379 5.793L3 14.172V17h2.828l8.38-8.38-2.827-2.828z" />
                            </svg>
                        </a>
                        <form action="{{ url_for('admin_delete_product', product_id=product.id) }}" method="POST" class="inline-block" onsubmit="return confirm('Are you sure you want to delete this product? This action cannot be undone.');">
                            <button type="submit"
                                    class="bg-transparent text-white transition duration-300 ease-in-out transform hover:scale-110 hover:text-gray-700 border-none cursor-pointer"
                                    title="Delete Product">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                    <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 000-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 011-1h4a1 1 0 110 2H8a1 1 0 01-1-1zm1 3a1 1 0 000 2h4a1 1 0 100-2H8z" clip-rule="evenodd" />
                                </svg>
                            </button>
                        </form>
                    </div>
                {% endif %}
            </div>
            <div class="p-5 flex flex-col flex-grow">
                <h2 class="text-xl font-semibold text-gray-800 mb-2 truncate">
                    <a href="{{ url_for('product_detail', product_id=product.id) }}" class="hover:text-blue-600 transition duration-300">
                        {{ product.name }}
                    </a>
                </h2>
                <p class="text-sm text-gray-500 mb-2">{{ product.category }}</p>
                <p class="text-gray-700 text-2xl font-bold mb-4">Rs.{{ "%.2f"|format(product.price) }}</p>
                <div class="mt-auto">
                    <a href="{{ url_for('product_detail', product_id=product.id) }}"
                       class="inline-block bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-300 ease-in-out transform hover:scale-105 w-full text-center">
                        View Details
                    </a>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
{% else %}
    <div class="bg-white rounded-xl shadow-lg p-8 text-center">
        <p class="text-xl text-gray-600 mb-4">No products found matching your criteria.</p>
        <a href="{{ url_for('index') }}" class="text-blue-600 hover:underline font-semibold">Clear Search/Filter</a>
    </div>
{% endif %}
{% endblock %}